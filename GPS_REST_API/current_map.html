<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Circles Experiment</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0%; bottom: 0; width: 100%; }
</style>
</head>
<body>
<p><?php echo json_encode($coords); ?></p>
<div id="map"></div>

<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
mapboxgl.accessToken = 'pk.eyJ1Ijoic3RyeW0iLCJhIjoiY2tydG4xamU1M2lyejJydGo0OWE4djcxbSJ9.BB-TcmFTyakTjI0J15jonQ';
//var center_lat=0.0;
//var center_long=0.0;

//var Coords= JSON.parse(<?php echo json_encode(json_encode($coords)); ?>);

//var gpstime = JSON.parse(<?php echo json_encode(json_encode($gpstime)); ?>);

//var CarNumbers = JSON.parse(<?php echo json_encode(json_encode($carnumbers)); ?>);
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [-86.65905585185185,  36.051528734567896],
zoom: 16
});

async function getLocationData() {
  const response = await fetch('http://ransom.isis.vanderbilt.edu/GPS_REST_API/current_map_data.php', { method: 'GET'});
  return await response.json();
}

async function getAndProcessLocationData() {
  const data = await getLocationData();
  var G = {};
  G["type"] = "FeatureCollection";
  G["features"] = [];
  G["features"][0] = {};
  console.log(data);
  for (let i = 0; i < data.coords.length; i++) {
    G["features"][i] = { "type": "Feature", "properties": { "gpstime": data.gpstime[i], "systime": data.systime[i], "velocity": data.velocity[i], "title": data.carnumbers[i]}, "geometry": { "type": "Point", "coordinates": data.coords[i] } };
  }
  return G;
}

const updateSource = setInterval(async () => {
  var G = await getAndProcessLocationData();
  map.getSource('G').setData(G);
}, 5000);

map.on('load', async () => {
  const G = await getAndProcessLocationData();
  map.addSource('G', {
    type: 'geojson',
    data: G
  });
  map.addLayer({
    id: 'datapoints',
    type: 'circle',
    source: 'G',
    paint: {
       'circle-radius': 14,
     "circle-color": "#4361ee",
    'circle-stroke-color': 'white',
    'circle-stroke-width': 1,
    'circle-opacity': 0.5
    }
  });
  map.addLayer({
    id: 'datapoints_label',
    type: 'symbol',
    source: 'G',
    'layout': {
      'text-field': ['get', 'title'],
      'text-font': [
        'Open Sans Semibold',
        'Arial Unicode MS Bold'
      ],
      'text-offset': [0, 1.25],
      'text-anchor': 'top'
    }
  });
});

  // Create a popup, but don't add it to the map yet.
  const popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });
  
  map.on('mouseenter', 'datapoints', (e) => {
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = 'pointer';
    
    // Copy coordinates array.
    const coordinates = e.features[0].geometry.coordinates.slice();
    var description = "<strong>Car "+e.features[0].properties.title.toString()+"</strong>";
    description += "<p>GPS Timestamp: "+e.features[0].properties.gpstime.toString()+"</p>";
    description += "<p>SYS Timestamp: "+e.features[0].properties.systime.toString()+"</p>";
    description += "<p>Velocity: "+e.features[0].properties.velocity.toString()+"</p>";
    
    // Ensure that if the map is zoomed out such that multiple
    // copies of the feature are visible, the popup appears
    // over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
    
    // Populate the popup and set its coordinates
    // based on the feature found.
    popup.setLngLat(coordinates).setHTML(description).addTo(map);
  });
    
  map.on('mouseleave', 'datapoints', () => {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

</script>

</body>
</html>
